version: '3.8'

networks:
  mongo_network:
    driver: bridge
  postgres_coinbasepro_network:
    driver: bridge
  postgres_polygon_network:
    driver: bridge

services:
  ctests:
    build:
      context: ../../
      dockerfile: third_party/docker/ctests.Dockerfile
    volumes:
      - /etc/alpine-hodler:/etc/alpine-hodler
    networks:
      - mongo_network
      - postgres_coinbasepro_network
      - postgres_polygon_network

# first, we define the three mongo servers that will act as replicas
# here, we steup the hostname ports, and startup command
# which is the same as discussed in the previous section
  mongo1:
    hostname: mongo1
    image: mongo
    ports:
      - 27017:27017
    restart: always
    entrypoint: [ "/usr/bin/mongod", "--bind_ip_all", "--replSet", "dbrs" ]
    networks:
      - mongo_network
    volumes:
      - ./../../.db/mongo1:/data/db
      - ./rs-init.sh:/scripts/rs-init.sh
    links:
      - mongo2
      - mongo3

  mongo2:
    hostname: mongo2
    image: mongo
    ports:
      - 27018:27017
    restart: always
    entrypoint: [ "/usr/bin/mongod", "--bind_ip_all", "--replSet", "dbrs" ]
    networks:
      - mongo_network
    volumes:
      - ./../../.db/mongo2:/data/db

  mongo3:
    hostname: mongo3
    image: mongo
    ports:
      - 27019:27017
    restart: always
    entrypoint: [ "/usr/bin/mongod", "--bind_ip_all", "--replSet", "dbrs" ]
    networks:
      - mongo_network
    volumes:
      - ./../../.db/mongo3:/data/db

  liquibase-mongo-coinbasepro:
    networks:
      - mongo_network
    build:
      context: ../../
      dockerfile: third_party/docker/liquibase-mongo.Dockerfile
    volumes:
      - ./../../third_party/liquibase/mongo/coinbasepro:/liquibase/changelog

  liquibase-mongo-polygon:
    networks:
      - mongo_network
    build:
      context: ../../
      dockerfile: third_party/docker/liquibase-mongo.Dockerfile
    volumes:
      - ./../../third_party/liquibase/mongo/polygon:/liquibase/changelog
  # PostgreSQL services for COINBASE PRO
  postgres-coinbasepro:
    hostname: postgres-coinbasepro
    networks:
      - postgres_coinbasepro_network
    image: postgres:11.1
    environment:
      POSTGRES_USER: postgres
      POSTGRES_DB: coinbasepro
    ports:
      - "5432:5432"
    volumes:
      - ./../../.db/postgres-coinbasepro-test-volume:/var/lib/postgresql/dat
    restart: "unless-stopped"

  liquibase-postgres-coinbasepro:
    networks:
      - postgres_coinbasepro_network
    image: liquibase/liquibase
    volumes:
      - ./../../third_party/liquibase/postgres/coinbasepro:/liquibase/changelog

  # PostgreSQL services for POLYGON
  postgres-polygon:
    hostname: postgres-polygon
    networks:
      - postgres_polygon_network
    image: postgres:11.1
    environment:
      POSTGRES_USER: postgres
      POSTGRES_DB: polygon
    ports:
      - "5433:5432"
    volumes:
      - ./../../.db/postgres-polygon-test-volume:/var/lib/postgresql/dat
    restart: "unless-stopped"
  liquibase-postgres-polygon:
    networks:
      - postgres_polygon_network
    image: liquibase/liquibase
    volumes:
      - ./../../third_party/liquibase/postgres/polygon:/liquibase/changelog
